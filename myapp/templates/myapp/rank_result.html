{% extends "myapp/base.html" %}
{% load static %}
{% block content %}
  <div style="display:flex;gap:18px;align-items:center;margin-bottom:18px;">
    {% if album.image %}
      <img src="{{ album.image }}" alt="{{ album.name }}" style="width:140px;height:140px;object-fit:cover;border-radius:8px" id="album-cover">
    {% endif %}
    <div style="flex:1">
      <h2>{{ album.name }}</h2>
      <p style="color:#6b7280">{{ album.artist }}</p>
      {% if user.is_authenticated and saved %}
        <p style="margin-top:8px;color:#10b981;font-size:14px">✓ Saved to My Music</p>
      {% endif %}
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <div style="position:relative;display:inline-block">
          <button id="export-btn" style="padding:8px 14px;background:#e5e7eb;color:#111;border:0;border-radius:6px;cursor:pointer;font-size:14px">Export ▼</button>
          <div id="export-menu" style="display:none;position:absolute;top:100%;left:0;margin-top:4px;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:10;min-width:120px">
            <button id="export-csv" style="display:block;width:100%;padding:8px 12px;text-align:left;background:none;border:0;cursor:pointer;font-size:14px">Export CSV</button>
            <button id="export-png" style="display:block;width:100%;padding:8px 12px;text-align:left;background:none;border:0;cursor:pointer;font-size:14px;border-top:1px solid #eee">Export PNG</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h3>Your Final Ranking</h3>
  <ol id="ranking-list">
    {% for track in ordered_tracks %}
      <li style="margin:6px 0" data-track-id="{{ track.id }}" data-track-name="{{ track.name }}" data-duration-ms="{{ track.duration_ms }}">
        {{ track.name }}
        <small style="color:#9ca3af;margin-left:8px;">{{ track.duration_formatted }}</small>
      </li>
    {% endfor %}
  </ol>

  <p style="margin-top:20px;color:#6b7280">Total comparisons: {{ comparisons_count }}</p>

  <div style="margin-top:18px;">
    <a href="{% url 'myapp:rank' album.id %}" style="padding:10px 14px;background:#111;color:#fff;border-radius:6px;text-decoration:none;">Restart Ranking</a>
    <a href="{% url 'myapp:search' %}" style="padding:10px 14px;margin-left:8px;background:#e5e7eb;color:#111;border-radius:6px;text-decoration:none;">Search New Album</a>
  </div>

  <script>
    const albumId = "{{ album_id }}";
    const orderedIds = {{ ordered_ids_json|safe }};
    const albumName = "{{ album.name|escapejs }}";
    const artistName = "{{ album.artist|escapejs }}";
    const albumImage = "{{ album.image|default:''|escapejs }}";
    const tracks = [
      {% for track in ordered_tracks %}
      {
        id: "{{ track.id|escapejs }}",
        name: "{{ track.name|escapejs }}",
        duration_ms: {{ track.duration_ms|default:0 }},
        track_number: {{ track.track_number|default:0 }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    const saved = {{ saved|yesno:"true,false" }};
    const csrfToken = "{{ csrf_token }}";
    const comparisonsCount = {{ comparisons_count }};
  </script>
  <script src="{% static 'myapp/js/rank_result.js' %}"></script>
{% endblock %}