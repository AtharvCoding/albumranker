{% extends "myapp/base.html" %}
{% load static %}
{% block content %}
  <div class="results-header">
    {% if album.image %}
      <img src="{{ album.image }}" alt="{{ album.name }}" id="album-cover">
    {% endif %}
    <div class="results-info">
      <h2>{{ album.name }}</h2>
      <p>{{ album.artist }}</p>
      {% if user.is_authenticated and saved %}
        <div class="saved-badge">✓ Saved to My Music</div>
      {% endif %}
      <div class="results-actions">
        <div class="export-menu-container">
          <button id="export-btn" class="btn btn-secondary">Export ▼</button>
          <div id="export-menu" class="export-menu">
            <button id="export-csv" type="button">Export as CSV</button>
            <button id="export-png" type="button">Export as Image</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h2 style="font-size: 28px; font-weight: 700; margin: 0 0 24px 0; color: #000000;">Your Final Ranking</h2>
  
  <div class="tracklist">
    <div class="tracklist-header">
      <div style="display: grid; grid-template-columns: 60px 1fr 100px; gap: 16px; padding: 0 16px;">
        <span>Rank</span>
        <span>Track</span>
        <span style="text-align: right;">Duration</span>
      </div>
    </div>
    {% for track in ordered_tracks %}
      <div class="track-row {% if forloop.counter <= 3 %}top-3{% endif %}" data-track-id="{{ track.id }}" data-track-name="{{ track.name }}" data-duration-ms="{{ track.duration_ms }}">
        <span class="rank">{{ forloop.counter }}</span>
        <div class="track-info">
          <div class="track-name">{{ track.name }}</div>
        </div>
        <span style="color: #666666; width: 100px; text-align: right;">{{ track.duration_formatted }}</span>
      </div>
    {% endfor %}
  </div>

  <p style="margin-top: 24px; color: #666666; font-size: 14px;">Total comparisons: {{ comparisons_count }}</p>

  <div style="margin-top: 32px; display: flex; gap: 12px; flex-wrap: wrap;">
    <a href="{% url 'myapp:rank' album.id %}" class="btn btn-primary">Restart Ranking</a>
    <a href="{% url 'myapp:search' %}" class="btn btn-secondary">Search New Album</a>
  </div>

  <script>
    const albumId = "{{ album_id }}";
    const orderedIds = {{ ordered_ids_json|safe }};
    const albumName = "{{ album.name|escapejs }}";
    const artistName = "{{ album.artist|escapejs }}";
    const albumImage = "{{ album.image|default:''|escapejs }}";
    const tracks = [
      {% for track in ordered_tracks %}
      {
        id: "{{ track.id|escapejs }}",
        name: "{{ track.name|escapejs }}",
        duration_ms: {{ track.duration_ms|default:0 }},
        track_number: {{ track.track_number|default:0 }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    const saved = {{ saved|yesno:"true,false" }};
    const csrfToken = "{{ csrf_token }}";
    const comparisonsCount = {{ comparisons_count }};
  </script>
  <script src="{% static 'myapp/js/rank_result.js' %}"></script>
{% endblock %}